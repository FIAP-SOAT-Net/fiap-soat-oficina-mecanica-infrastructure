version: '3.8'

services:
  # API .NET
  api:
    image: ghcr.io/fiap-soat-net/fiap-soat-oficina-mecanica:latest
    container_name: smart-workshop-api
    ports:
      - "5180:5180"
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:5180
      - ConnectionStrings__DefaultConnection=${DB_CONNECTION_STRING}
      - Email__SmtpHost=mailhog
      - Email__SmtpPort=1025
      - Email__SmtpUsername=
      - Email__SmtpPassword=
      - Email__EnableSsl=false
      - Email__SenderAddress=noreply@smartworkshop.com
      - Email__SenderName=Smart Workshop
      - BaseUrl=http://localhost:5180
      - Jwt__Key=${JWT_SECRET_KEY:-your-super-secret-key-min-32-chars-long-12345678}
      - Jwt__Issuer=SmartWorkshop
      - Jwt__Audience=SmartWorkshopUsers
      - Jwt__ExpiresInMinutes=60
    depends_on:
      - mailhog
    networks:
      - smart-workshop-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5180/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # MailHog - SMTP Testing
  mailhog:
    image: mailhog/mailhog:v1.0.1
    container_name: smart-workshop-mailhog
    ports:
      - "1025:1025"  # SMTP
      - "8025:8025"  # Web UI
    networks:
      - smart-workshop-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8025"]
      interval: 30s
      timeout: 10s
      retries: 3

networks:
  smart-workshop-network:
    driver: bridge
    name: smart-workshop-network
